{% extends 'base.html' %}
{% block title %}Gestión de Pedidos - La Fornería{% endblock %}

{% block content %}
<div class="container mt-5">

    {% if user.is_staff or user.is_superuser %}
        <!-- Encabezado con buscador y exportación -->
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
            <h2 class="mb-0">Gestión de Pedidos</h2>

            <div class="d-flex gap-2">
                <form method="GET" class="d-flex align-items-center gap-2">
                    <input type="text" name="q" class="form-control" placeholder="Buscar por cliente o estado..." value="{{ request.GET.q }}">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="bi bi-search"></i> Buscar
                    </button>
                </form>
                <!-- Botón con alerta SweetAlert -->
                <a href="{% url 'pedidos:exportar_pedidos_excel' %}" 
                   id="btn-exportar-excel" 
                   class="btn btn-success">
                    <i class="bi bi-file-earmark-excel"></i> Exportar Excel
                </a>
            </div>
        </div>

        {% if pedidos %}
        <div class="card shadow-sm border-0">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>ID Pedido</th>
                                <th>Cliente</th>
                                <th>Correo</th>
                                <th>Fecha</th>
                                <th>Total</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pedido in pedidos %}
                            <tr>
                                <td>#{{ pedido.id }}</td>
                                <td>{{ pedido.usuario.first_name }} {{ pedido.usuario.last_name }}</td>
                                <td>{{ pedido.usuario.email }}</td>
                                <td>{{ pedido.fecha_pedido|date:"d/m/Y H:i" }}</td>
                                <td>${{ pedido.total|floatformat:0 }}</td>
                                <td>
                                    {% if pedido.estado == "Pendiente" %}
                                        <span class="badge bg-warning text-dark">{{ pedido.estado }}</span>
                                    {% elif pedido.estado == "En preparación" %}
                                        <span class="badge bg-info text-dark">{{ pedido.estado }}</span>
                                    {% elif pedido.estado == "Enviado" %}
                                        <span class="badge bg-primary">{{ pedido.estado }}</span>
                                    {% elif pedido.estado == "Completado" %}
                                        <span class="badge bg-success">{{ pedido.estado }}</span>
                                    {% elif pedido.estado == "Cancelado" %}
                                        <span class="badge bg-danger">{{ pedido.estado }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ pedido.estado }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{% url 'pedidos:pedido_detail' pedido.id %}" 
                                       class="btn btn-sm btn-outline-info">
                                        <i class="bi bi-eye"></i> Ver Detalle
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-info text-center shadow-sm">
            No hay pedidos registrados aún.
        </div>
        {% endif %}
    
    {% else %}
        <!-- Si el usuario no es admin -->
        <div class="alert alert-danger text-center mt-5 p-5 shadow-sm rounded">
            <h4 class="fw-bold text-danger">
                <i class="bi bi-exclamation-triangle-fill"></i> Acceso Restringido
            </h4>
            <p>Solo los administradores pueden acceder al listado de pedidos.</p>
            <a href="{% url 'pedidos:ver_productos' %}" class="btn btn-primary mt-3">
                <i class="bi bi-arrow-left"></i> Volver a la Tienda
            </a>
        </div>
    {% endif %}
</div>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Alerta de Exportación -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const btnExport = document.getElementById("btn-exportar-excel");
    if (btnExport) {
        btnExport.addEventListener("click", (event) => {
            event.preventDefault(); // evita redirección inmediata

            Swal.fire({
                title: "Generando archivo...",
                text: "Por favor espera unos segundos mientras preparamos el Excel.",
                icon: "info",
                showConfirmButton: false,
                timer: 2000,
                didClose: () => {
                    window.location.href = btnExport.href; // descarga tras el mensaje
                }
            });
        });
    }
});
</script>

<!-- Mensajes Django -->
{% if messages %}
    {% for message in messages %}
        <script>
            Swal.fire({
                icon: '{% if message.tags == "success" %}success{% elif message.tags == "error" %}error{% else %}info{% endif %}',
                title: '{{ message|escapejs }}',
                timer: 2500,
                showConfirmButton: false
            });
        </script>
    {% endfor %}
{% endif %}
{% endblock %}
